name: Deploy

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  NEXT_PUBLIC_MENTRA_API_BASE_URL: ${{ vars.NEXT_PUBLIC_MENTRA_API_BASE_URL || '' }}
  NEXT_PUBLIC_MENTRA_TENANT_ID: ${{ vars.NEXT_PUBLIC_MENTRA_TENANT_ID || 'demo' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Run lint
        run: pnpm lint

      - name: Run tests
        run: pnpm test

      - name: Build frontend
        run: pnpm --filter frontend run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Fetch prerequisite stack outputs
        id: prereq-outputs
        run: |
          STACK_NAME=MentraPrereqStack
          OUTPUTS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs" --output json)
          echo "deploy_role_arn=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="GithubDeployRoleArn") | .OutputValue')" >> "$GITHUB_OUTPUT"
          echo "oidc_provider_arn=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="GithubOidcProviderArn") | .OutputValue')" >> "$GITHUB_OUTPUT"

      - name: Bootstrap CDK environment
        env:
          DEPLOY_ROLE_ARN: ${{ steps.prereq-outputs.outputs.deploy_role_arn }}
        run: |
          if [ -z "$DEPLOY_ROLE_ARN" ]; then
            echo "MentraPrereqStack did not return GithubDeployRoleArn output" >&2
            exit 1
          fi
          CDK_NEW_BOOTSTRAP=1 pnpm --dir infra/cdk exec cdk bootstrap \
            --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess \
            --trust "$DEPLOY_ROLE_ARN"

      - name: Deploy infrastructure
        env:
          MENTRA_GITHUB_ROLE_STRATEGY: import
          MENTRA_GITHUB_ROLE_ARN: ${{ steps.prereq-outputs.outputs.deploy_role_arn }}
          MENTRA_GITHUB_PROVIDER_STRATEGY: import
          MENTRA_GITHUB_PROVIDER_ARN: ${{ steps.prereq-outputs.outputs.oidc_provider_arn }}
        run: pnpm --dir infra/cdk exec cdk deploy MentraStack --require-approval never

      - name: Fetch stack outputs
        id: stack-outputs
        run: |
          STACK_NAME=MentraStack
          OUTPUTS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query "Stacks[0].Outputs" --output json)
          echo "bucket=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="FrontendBucketName") | .OutputValue')" >> "$GITHUB_OUTPUT"
          echo "distribution=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="CloudFrontDistributionId") | .OutputValue')" >> "$GITHUB_OUTPUT"

      - name: Sync frontend assets to S3
        if: steps.stack-outputs.outputs.bucket != ''
        run: aws s3 sync apps/frontend/out "s3://${{ steps.stack-outputs.outputs.bucket }}" --delete

      - name: Invalidate CloudFront cache
        if: steps.stack-outputs.outputs.distribution != ''
        run: aws cloudfront create-invalidation --distribution-id "${{ steps.stack-outputs.outputs.distribution }}" --paths "/*"
